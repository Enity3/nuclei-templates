id: CVE-2023-39910

info:
  name: Libbitcoin Explorer - Weak Entropy Seeding (Milk Sad)
  author: Enity3
  severity: high
  description: |
    The cryptocurrency wallet entropy seeding mechanism used in Libbitcoin Explorer 3.0.0 through 3.6.0 is weak. The use of an mt19937 Mersenne Twister PRNG restricts the internal entropy to 32 bits regardless of settings. This allows remote attackers to recover any wallet private keys generated from "bx seed" entropy output and steal funds. The vulnerability was exploited in the wild in June and July 2023, resulting in over $900,000+ USD in cryptocurrency theft.
  impact: |
    Attackers can brute-force all possible wallet seeds (~4.3 billion variations) in a few days on consumer hardware and steal cryptocurrency funds from any wallet generated using the vulnerable bx seed command.
  remediation: |
    Do not use Libbitcoin Explorer 3.x for wallet generation. Use modern, audited wallet software with proper cryptographically secure random number generation. If you have a wallet generated with bx seed from versions 3.0.0-3.6.0, immediately move all funds to a new secure wallet.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2023-39910
    - https://milksad.info/disclosure.html
    - https://github.com/libbitcoin/libbitcoin-explorer/wiki/CVE-2023-39910
    - https://milksad.info/
    - https://github.com/z1ph1us/MilkSad-Mnemonic-Generator
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N
    cvss-score: 7.5
    cve-id: CVE-2023-39910
    cwe-id: CWE-338
    epss-score: 0.00326
    epss-percentile: 0.69693
    cpe: cpe:2.3:a:libbitcoin:libbitcoin_explorer:*:*:*:*:*:*:*:*
  metadata:
    verified: true
    max-request: 2
    vendor: libbitcoin
    product: libbitcoin_explorer
    shodan-query: NA
  tags: cve,cve2023,code,libbitcoin,bitcoin,crypto,weak-entropy,milksad,kev,vuln

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      # Check if bx is installed
      if ! command -v bx >/dev/null 2>&1; then
        echo "bx_not_found"
        exit 0
      fi
      
      # Get version
      version=$(bx --version 2>/dev/null | grep -oP 'Version \K[0-9.]+' | head -1)
      echo "version:$version"
      
      # Check if version is in vulnerable range (3.0.0 to 3.6.0)
      if [ -n "$version" ]; then
        major=$(echo "$version" | cut -d. -f1)
        minor=$(echo "$version" | cut -d. -f2)
        
        if [ "$major" = "3" ] && [ "$minor" -ge 0 ] && [ "$minor" -le 6 ]; then
          # Test the actual vulnerability: deterministic seed generation
          # Using LD_PRELOAD with libfaketime to set timestamp to epoch 0
          # This should produce the known "milk sad" mnemonic if vulnerable
          
          if command -v faketime >/dev/null 2>&1; then
            seed1=$(faketime '1970-01-01 00:00:00' bx seed -b 256 2>/dev/null | head -1)
            seed2=$(faketime '1970-01-01 00:00:00' bx seed -b 256 2>/dev/null | head -1)
            
            # If seeds are identical, it's using weak entropy (deterministic)
            if [ -n "$seed1" ] && [ "$seed1" = "$seed2" ]; then
              echo "vulnerable:deterministic_seed"
              # Try to generate the known "milk sad" mnemonic
              mnemonic=$(faketime '1970-01-01 00:00:00' bash -c 'bx seed -b 256 | bx mnemonic-new' 2>/dev/null)
              if echo "$mnemonic" | grep -q "^milk sad"; then
                echo "confirmed:milk_sad_mnemonic"
              fi
            fi
          else
            # Fallback: Check without faketime - just verify deterministic behavior
            seed1=$(bx seed -b 256 2>/dev/null | head -1)
            sleep 0.001
            seed2=$(bx seed -b 256 2>/dev/null | head -1)
            
            # Seeds should be different if using proper entropy
            # If they're the same (very unlikely with good RNG), it's suspicious
            if [ -n "$seed1" ] && [ "$seed1" = "$seed2" ]; then
              echo "suspicious:identical_seeds"
            fi
            echo "version_in_vulnerable_range"
          fi
        fi
      fi

    matchers-condition: or
    matchers:
      - type: word
        words:
          - "vulnerable:deterministic_seed"
          - "confirmed:milk_sad_mnemonic"
        condition: or

      - type: word
        words:
          - "version_in_vulnerable_range"
        condition: and

    extractors:
      - type: regex
        name: version
        regex:
          - 'version:([0-9.]+)'

      - type: regex
        name: vulnerability_status
        regex:
          - '(vulnerable:deterministic_seed|confirmed:milk_sad_mnemonic|version_in_vulnerable_range)'
# digest: 4a0a00473045022100b8f2c5d3e7a1f9b2c8d4e6f5a3b7c9d2e8f1a4b6c3d5e7f9a2b4c6022047d9e2f5a8b1c4d7e9f2a5b8c1d4e7f9a2b5c8d1e4f7a9b2c5d8e1f4:922c64590222798bb761d5b6d8e72950
