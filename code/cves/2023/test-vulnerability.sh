#!/bin/bash

# CVE-2023-39910 Non-Simulated Testing Script
# This script tests the REAL vulnerability using the actual vulnerable software

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "================================================"
echo "CVE-2023-39910 - Real Vulnerability Test"
echo "Libbitcoin Explorer Weak Entropy (Milk Sad)"
echo "================================================"
echo ""

# Check prerequisites
echo "[*] Checking prerequisites..."

if ! command -v docker &> /dev/null; then
    echo -e "${RED}[!] Docker is not installed${NC}"
    echo "[*] Please install Docker first:"
    echo "    https://docs.docker.com/get-docker/"
    exit 1
fi

echo -e "${GREEN}[✓] Docker is installed${NC}"
echo ""

# Build the test environment
echo "[*] Building test environment with REAL vulnerable bx 3.6.0..."
echo "[*] Downloading from official GitHub release..."
cd "$(dirname "$0")"

docker build -t cve-2023-39910-test -f Dockerfile.test . || {
    echo -e "${RED}[!] Failed to build Docker image${NC}"
    exit 1
}

echo -e "${GREEN}[✓] Test environment built successfully${NC}"
echo ""

# Run the vulnerability test
echo "================================================"
echo "Running REAL vulnerability test..."
echo "================================================"
echo ""

docker run --rm cve-2023-39910-test

echo ""
echo "================================================"
echo "MANUAL VERIFICATION STEPS"
echo "================================================"
echo ""
echo "You can manually verify by running:"
echo ""
echo "1. Start interactive container:"
echo "   docker run -it --rm cve-2023-39910-test /bin/bash"
echo ""
echo "2. Inside container, run these commands:"
echo "   # Test 1: Deterministic seed (smoking gun)"
echo "   faketime '1970-01-01 00:00:00' bx seed -b 256"
echo "   faketime '1970-01-01 00:00:00' bx seed -b 256"
echo "   # Both outputs should be IDENTICAL if vulnerable"
echo ""
echo "3. Test the famous 'milk sad' mnemonic:"
echo "   faketime '1970-01-01 00:00:00' bash -c 'bx seed -b 256 | bx mnemonic-new'"
echo "   # Should output: milk sad wage cup reward umbrella..."
echo ""
echo "================================================"
echo "EXPECTED VULNERABLE OUTPUT"
echo "================================================"
echo ""
echo "Seed at epoch 0 should be:"
echo "   2092e79763b9c9e1d8c62f99d2e86dc2e05934ffd80fd8c7cb87de48c27bfae3"
echo ""
echo "Mnemonic at epoch 0 should start with:"
echo "   milk sad wage cup reward umbrella raven visa..."
echo ""
echo "If you see these exact values, CVE-2023-39910 is CONFIRMED!"
echo ""

# Test with nuclei if available
if command -v nuclei &> /dev/null; then
    echo "================================================"
    echo "Testing with Nuclei Template"
    echo "================================================"
    echo ""
    echo "[*] Running nuclei template against container..."
    
    # Start container in background
    container_id=$(docker run -d cve-2023-39910-test tail -f /dev/null)
    
    echo "[*] Container ID: $container_id"
    echo "[*] Running nuclei scan..."
    
    # Run nuclei (this would need proper setup to scan inside container)
    echo "[*] Note: Nuclei code templates run on local system"
    echo "[*] To test template, you need bx installed locally or use SSH target"
    
    # Cleanup
    docker stop $container_id > /dev/null 2>&1
    
    echo ""
    echo "To test the nuclei template locally:"
    echo "1. Install bx on your system (in a VM/container for safety)"
    echo "2. Run: nuclei -t code/cves/2023/CVE-2023-39910.yaml -target localhost -debug"
else
    echo "[*] Nuclei not installed. Skipping template test."
    echo "[*] Install nuclei: go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
fi

echo ""
echo "================================================"
echo "TEST COMPLETE"
echo "================================================"
