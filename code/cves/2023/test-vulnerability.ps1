# CVE-2023-39910 Non-Simulated Testing Script (Windows/PowerShell)
# This script tests the REAL vulnerability using the actual vulnerable software

Write-Host "================================================" -ForegroundColor Cyan
Write-Host "CVE-2023-39910 - Real Vulnerability Test" -ForegroundColor Cyan
Write-Host "Libbitcoin Explorer Weak Entropy (Milk Sad)" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""

# Check Docker
Write-Host "[*] Checking prerequisites..." -ForegroundColor Yellow

$dockerInstalled = Get-Command docker -ErrorAction SilentlyContinue

if (-not $dockerInstalled) {
    Write-Host "[!] Docker is not installed" -ForegroundColor Red
    Write-Host "[*] Please install Docker Desktop for Windows:"
    Write-Host "    https://docs.docker.com/desktop/install/windows-install/"
    exit 1
}

$dockerVersion = docker --version 2>$null
Write-Host "[checkmark] Docker is installed: $dockerVersion" -ForegroundColor Green

# Check if Docker Desktop is running
$dockerRunning = docker ps 2>$null
if ($LASTEXITCODE -ne 0) {
    Write-Host "" 
    Write-Host "[!] Docker Desktop is not running!" -ForegroundColor Red
    Write-Host "[*] Please start Docker Desktop and try again." -ForegroundColor Yellow
    Write-Host ""
    Write-Host "Steps:" -ForegroundColor Yellow
    Write-Host "1. Open Docker Desktop from Start menu"
    Write-Host "2. Wait for it to fully start (whale icon in system tray)"
    Write-Host "3. Run this script again"
    Write-Host ""
    exit 1
}

Write-Host ""

# Build the test environment
Write-Host "[*] Building test environment with REAL vulnerable bx 3.2.0..." -ForegroundColor Yellow
Write-Host "[*] Compiling from source code (this may take a few minutes)..." -ForegroundColor Yellow
Write-Host "[*] This is the ACTUAL vulnerable code exploited in the wild!" -ForegroundColor Yellow

$scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
Set-Location $scriptDir

Write-Host ""
docker build -t cve-2023-39910-test -f Dockerfile.test .

if ($LASTEXITCODE -ne 0) {
    Write-Host ""
    Write-Host "[!] Failed to build Docker image" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "[checkmark] Test environment built successfully" -ForegroundColor Green
Write-Host ""

# Run the vulnerability test
Write-Host "================================================" -ForegroundColor Cyan
Write-Host "Running REAL vulnerability test..." -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""

docker run --rm cve-2023-39910-test

Write-Host ""
Write-Host "================================================" -ForegroundColor Cyan
Write-Host "MANUAL VERIFICATION STEPS" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "You can manually verify by running:" -ForegroundColor Yellow
Write-Host ""
Write-Host "1. Start interactive container:"
Write-Host "   docker run -it --rm cve-2023-39910-test /bin/bash" -ForegroundColor White
Write-Host ""
Write-Host "2. Inside container, run these commands:"
Write-Host "   # Test 1: Deterministic seed (smoking gun)" -ForegroundColor Gray
Write-Host "   faketime '1970-01-01 00:00:00' bx seed -b 256" -ForegroundColor White
Write-Host "   faketime '1970-01-01 00:00:00' bx seed -b 256" -ForegroundColor White
Write-Host "   # Both outputs should be IDENTICAL if vulnerable" -ForegroundColor Gray
Write-Host ""
Write-Host "3. Test the famous 'milk sad' mnemonic:"
Write-Host "   faketime '1970-01-01 00:00:00' bash -c 'bx seed -b 256 | bx mnemonic-new'" -ForegroundColor White
Write-Host "   # Should output: milk sad wage cup reward umbrella..." -ForegroundColor Gray
Write-Host ""
Write-Host "================================================" -ForegroundColor Cyan
Write-Host "EXPECTED VULNERABLE OUTPUT" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "Seed at epoch 0 should be:"
Write-Host "   2092e79763b9c9e1d8c62f99d2e86dc2e05934ffd80fd8c7cb87de48c27bfae3" -ForegroundColor Yellow
Write-Host ""
Write-Host "Mnemonic at epoch 0 should start with:"
Write-Host "   milk sad wage cup reward umbrella raven visa..." -ForegroundColor Yellow
Write-Host ""
Write-Host "If you see these exact values, CVE-2023-39910 is CONFIRMED!" -ForegroundColor Red
Write-Host ""

# Test with nuclei if available
$nucleiInstalled = Get-Command nuclei -ErrorAction SilentlyContinue

if ($nucleiInstalled) {
    Write-Host "================================================" -ForegroundColor Cyan
    Write-Host "Testing with Nuclei Template" -ForegroundColor Cyan
    Write-Host "================================================" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "[*] Nuclei is installed" -ForegroundColor Green
    Write-Host ""
    Write-Host "To test the nuclei template locally:" -ForegroundColor Yellow
    Write-Host "1. Install bx on your system (in a VM/container for safety)"
    Write-Host "2. Run: nuclei -t code/cves/2023/CVE-2023-39910.yaml -target localhost -debug" -ForegroundColor White
} else {
    Write-Host "[*] Nuclei not installed. Skipping template test." -ForegroundColor Yellow
    Write-Host "[*] Install nuclei: go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest"
}

Write-Host ""
Write-Host "================================================" -ForegroundColor Cyan
Write-Host "TEST COMPLETE" -ForegroundColor Cyan
Write-Host "================================================" -ForegroundColor Cyan
